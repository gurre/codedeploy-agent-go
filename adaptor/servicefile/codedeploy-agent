#!/bin/bash

# Init file for codedeploy-agent (Go binary)
#
# chkconfig: 2345 98 02
# description: codedeploy-agent processes the deployments created by AWS CodeDeploy and installs \
# the deployment artifacts on to this instance.

### BEGIN INIT INFO
# Provides:          codedeploy-agent
# Required-Start:    $all
# Required-Stop:     $remote_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: AWS CodeDeploy Host Agent
# Description:       codedeploy-agent processes the deployments created by AWS CodeDeploy and installs
#                    the deployment artifacts on to this instance.
### END INIT INFO

COMMAND=$1
RETVAL=0
[ -f /etc/profile ] && [ "$(stat --format '%U %G' /etc/profile)" = "root root" ] && source /etc/profile

prog="codedeploy-agent"
BIN="/opt/codedeploy-agent/bin/codedeploy-agent"
CONFIG="/etc/codedeploy-agent/conf/codedeployagent.yml"
PIDFILE="/var/run/codedeploy-agent.pid"

# Modify to run as a non-root user. You must also chown
# /opt/codedeploy-agent /var/log/aws to this user.
CODEDEPLOY_USER=""

getpid() {
    if [ -f "$PIDFILE" ]; then
        local pid
        pid=$(cat "$PIDFILE" 2>/dev/null)
        if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
            echo "$pid"
            return 0
        fi
    fi
    return 1
}

start() {
    echo -n "Starting $prog: "
    local pid
    if pid=$(getpid); then
        echo "already running (PID $pid)"
        return 0
    fi

    if [ -n "$CODEDEPLOY_USER" ]; then
        nohup sudo -u "$CODEDEPLOY_USER" "$BIN" "$CONFIG" >/dev/null 2>&1 &
    else
        nohup "$BIN" "$CONFIG" >/dev/null 2>&1 &
    fi
    echo $! > "$PIDFILE"
    echo "done"
}

stop() {
    echo -n "Stopping $prog: "
    local pid
    if ! pid=$(getpid); then
        echo "not running"
        return 0
    fi

    kill -TERM "$pid" 2>/dev/null
    # Wait up to 30 seconds for graceful shutdown.
    local i=0
    while [ $i -lt 30 ] && kill -0 "$pid" 2>/dev/null; do
        sleep 1
        i=$((i + 1))
    done

    if kill -0 "$pid" 2>/dev/null; then
        kill -KILL "$pid" 2>/dev/null
    fi
    rm -f "$PIDFILE"
    echo "done"
}

status() {
    local pid
    if pid=$(getpid); then
        echo "$prog is running (PID $pid)"
        return 0
    else
        echo "$prog is not running"
        return 3
    fi
}

case "$COMMAND" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart|force-reload)
        stop
        start
        ;;
    status)
        status
        ;;
    *)
        echo "Usage: $0 {start|stop|status|restart}"
        exit 1
esac
